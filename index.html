<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÁæéÂõΩÂú∞ÂõæÊãºÂõæÊ∏∏Êàè | US Map Puzzle</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/topojson.v3.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
    background: linear-gradient(135deg, #0a1628 0%, #1a2a4a 50%, #0d1f3c 100%);
    color: #fff;
    min-height: 100vh;
    overflow: hidden;
  }

  #header {
    text-align: center;
    padding: 12px 0 4px;
    position: relative;
    z-index: 10;
  }

  #header h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 2px;
  }

  #header p {
    font-size: 13px;
    color: #94a3b8;
    margin-top: 2px;
  }

  #map-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: calc(100vh - 80px);
    position: relative;
  }

  #map-svg {
    width: 100%;
    height: 100%;
  }

  .state-path {
    stroke: #1e293b;
    stroke-width: 1;
    cursor: pointer;
    transition: filter 0.2s, stroke-width 0.2s;
  }

  .state-path:hover {
    filter: brightness(1.3) drop-shadow(0 0 8px rgba(255,255,255,0.3));
    stroke-width: 2;
    stroke: #fff;
  }

  .state-label {
    font-size: 9px;
    fill: #fff;
    text-anchor: middle;
    pointer-events: none;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    opacity: 0.9;
  }

  .state-label-small {
    font-size: 7px;
  }

  /* Modal overlay */
  #modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
  }

  #modal-overlay.active {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from { transform: translateY(40px) scale(0.95); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
  }

  @keyframes zoomState {
    from { transform: scale(0.3); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  #modal-content {
    background: linear-gradient(145deg, #1e293b, #0f172a);
    border: 1px solid rgba(96,165,250,0.3);
    border-radius: 20px;
    padding: 0;
    width: 680px;
    max-width: 92vw;
    max-height: 88vh;
    overflow: hidden;
    animation: slideUp 0.4s ease;
    box-shadow: 0 25px 60px rgba(0,0,0,0.5), 0 0 40px rgba(96,165,250,0.1);
  }

  #modal-header {
    padding: 24px 28px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  #modal-state-name {
    font-size: 32px;
    font-weight: 700;
    color: #f1f5f9;
  }

  #modal-state-name-cn {
    font-size: 20px;
    color: #94a3b8;
    margin-top: 2px;
  }

  #modal-close {
    background: rgba(255,255,255,0.08);
    border: none;
    color: #94a3b8;
    font-size: 22px;
    cursor: pointer;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  #modal-close:hover {
    background: rgba(239,68,68,0.2);
    color: #ef4444;
  }

  #modal-body {
    display: flex;
    padding: 20px 28px 28px;
    gap: 24px;
  }

  #state-shape-container {
    flex: 0 0 200px;
    height: 180px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.06);
  }

  #state-shape-svg {
    width: 180px;
    height: 160px;
  }

  #state-shape-svg .zoomed-state {
    animation: zoomState 0.5s ease;
  }

  #state-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .info-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .info-icon {
    font-size: 22px;
    width: 36px;
    text-align: center;
    flex-shrink: 0;
  }

  .info-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .info-value {
    font-size: 16px;
    font-weight: 600;
    color: #e2e8f0;
  }

  .info-value-sub {
    font-size: 12px;
    color: #94a3b8;
    font-weight: 400;
  }

  #speak-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #3b82f6, #6366f1);
    border: none;
    color: #fff;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    margin-top: 4px;
    align-self: flex-start;
  }

  #speak-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(99,102,241,0.4);
  }

  #speak-btn:active {
    transform: scale(0.97);
  }

  /* small states legend on east coast */
  .state-line {
    stroke: #94a3b8;
    stroke-width: 0.5;
    opacity: 0.6;
  }
</style>
</head>
<body>

<div id="header">
  <h1>United States Puzzle Map</h1>
  <p>ÁÇπÂáª‰ªªÊÑè‰∏Ä‰∏™Â∑ûÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ | Click any state for details</p>
</div>

<div id="map-container">
  <svg id="map-svg"></svg>
</div>

<div id="modal-overlay">
  <div id="modal-content">
    <div id="modal-header">
      <div>
        <div id="modal-state-name">California</div>
        <div id="modal-state-name-cn">Âä†Âà©Á¶èÂ∞º‰∫öÂ∑û</div>
      </div>
      <button id="modal-close" title="ÂÖ≥Èó≠">&times;</button>
    </div>
    <div id="modal-body">
      <div id="state-shape-container">
        <svg id="state-shape-svg" viewBox="0 0 200 200"></svg>
      </div>
      <div id="state-info">
        <div class="info-row">
          <div class="info-icon">üèõÔ∏è</div>
          <div>
            <div class="info-label">Capital È¶ñÈÉΩ</div>
            <div class="info-value" id="info-capital">Sacramento</div>
            <div class="info-value-sub" id="info-capital-cn">Ëê®ÂÖãÊãâÈó®Êâò</div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-icon">üë•</div>
          <div>
            <div class="info-label">Population ‰∫∫Âè£</div>
            <div class="info-value" id="info-population">39,538,223</div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-icon">üí∞</div>
          <div>
            <div class="info-label">GDP Per Capita ‰∫∫ÂùáGDP</div>
            <div class="info-value" id="info-gdp">$85,546</div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-icon">üìç</div>
          <div>
            <div class="info-label">Abbreviation Áº©ÂÜô</div>
            <div class="info-value" id="info-abbrev">CA</div>
          </div>
        </div>
        <button id="speak-btn">üîä Hear Pronunciation</button>
      </div>
    </div>
  </div>
</div>

<script>
// ========== STATE DATA ==========
const stateData = {
  "AL": { name: "Alabama", cn: "ÈòøÊãâÂ∑¥È©¨Â∑û", capital: "Montgomery", capitalCn: "ËíôÂì•È©¨Âà©", population: 5024279, gdpPerCapita: 46479, fips: "01" },
  "AK": { name: "Alaska", cn: "ÈòøÊãâÊñØÂä†Â∑û", capital: "Juneau", capitalCn: "Êú±ËØ∫", population: 733391, gdpPerCapita: 73205, fips: "02" },
  "AZ": { name: "Arizona", cn: "‰∫öÂà©Ê°ëÈÇ£Â∑û", capital: "Phoenix", capitalCn: "Âá§Âá∞Âüé", population: 7151502, gdpPerCapita: 52789, fips: "04" },
  "AR": { name: "Arkansas", cn: "ÈòøËÇØËâ≤Â∑û", capital: "Little Rock", capitalCn: "Â∞èÁü≥Âüé", population: 3011524, gdpPerCapita: 43033, fips: "05" },
  "CA": { name: "California", cn: "Âä†Âà©Á¶èÂ∞º‰∫öÂ∑û", capital: "Sacramento", capitalCn: "Ëê®ÂÖãÊãâÈó®Êâò", population: 39538223, gdpPerCapita: 85546, fips: "06" },
  "CO": { name: "Colorado", cn: "ÁßëÁΩóÊãâÂ§öÂ∑û", capital: "Denver", capitalCn: "‰∏π‰Ωõ", population: 5773714, gdpPerCapita: 72331, fips: "08" },
  "CT": { name: "Connecticut", cn: "Â∫∑Ê∂ÖÁãÑÊ†ºÂ∑û", capital: "Hartford", capitalCn: "ÂìàÁâπÁ¶èÂæ∑", population: 3605944, gdpPerCapita: 82571, fips: "09" },
  "DE": { name: "Delaware", cn: "ÁâπÊãâÂçéÂ∑û", capital: "Dover", capitalCn: "Â§ö‰Ωõ", population: 989948, gdpPerCapita: 79879, fips: "10" },
  "FL": { name: "Florida", cn: "‰ΩõÁΩóÈáåËææÂ∑û", capital: "Tallahassee", capitalCn: "Â°îÊãâÂìàË•ø", population: 21538187, gdpPerCapita: 51847, fips: "12" },
  "GA": { name: "Georgia", cn: "‰ΩêÊ≤ª‰∫öÂ∑û", capital: "Atlanta", capitalCn: "‰∫öÁâπÂÖ∞Â§ß", population: 10711908, gdpPerCapita: 58056, fips: "13" },
  "HI": { name: "Hawaii", cn: "Â§èÂ®ÅÂ§∑Â∑û", capital: "Honolulu", capitalCn: "Ê™ÄÈ¶ôÂ±±", population: 1455271, gdpPerCapita: 63530, fips: "15" },
  "ID": { name: "Idaho", cn: "Áà±ËææËç∑Â∑û", capital: "Boise", capitalCn: "Âçö‰ºäË•ø", population: 1839106, gdpPerCapita: 47394, fips: "16" },
  "IL": { name: "Illinois", cn: "‰ºäÂà©ËØ∫‰ºäÂ∑û", capital: "Springfield", capitalCn: "ÊñØÊôÆÊûóËè≤Â∞îÂæ∑", population: 12812508, gdpPerCapita: 71479, fips: "17" },
  "IN": { name: "Indiana", cn: "Âç∞Á¨¨ÂÆâÁ∫≥Â∑û", capital: "Indianapolis", capitalCn: "Âç∞Á¨¨ÂÆâÁ∫≥Ê≥¢Âà©ÊñØ", population: 6785528, gdpPerCapita: 54181, fips: "18" },
  "IA": { name: "Iowa", cn: "ËâæÂ••Áì¶Â∑û", capital: "Des Moines", capitalCn: "ÂæóÊ¢ÖÂõ†", population: 3190369, gdpPerCapita: 58570, fips: "19" },
  "KS": { name: "Kansas", cn: "Â†™Ëê®ÊñØÂ∑û", capital: "Topeka", capitalCn: "ÊâòÁöÆÂç°", population: 2937880, gdpPerCapita: 56422, fips: "20" },
  "KY": { name: "Kentucky", cn: "ËÇØÂ°îÂü∫Â∑û", capital: "Frankfort", capitalCn: "Ê≥ïÂÖ∞ÂÖãÁ¶è", population: 4505836, gdpPerCapita: 46744, fips: "21" },
  "LA": { name: "Louisiana", cn: "Ë∑ØÊòìÊñØÂÆâÈÇ£Â∑û", capital: "Baton Rouge", capitalCn: "Â∑¥ÂêûÈ≤ÅÊó•", population: 4657757, gdpPerCapita: 52094, fips: "22" },
  "ME": { name: "Maine", cn: "ÁºÖÂõ†Â∑û", capital: "Augusta", capitalCn: "Â••Âè§ÊñØÂ°î", population: 1362359, gdpPerCapita: 49220, fips: "23" },
  "MD": { name: "Maryland", cn: "È©¨ÈáåÂÖ∞Â∑û", capital: "Annapolis", capitalCn: "ÂÆâÁ∫≥Ê≥¢Âà©ÊñØ", population: 6177224, gdpPerCapita: 65545, fips: "24" },
  "MA": { name: "Massachusetts", cn: "È©¨Ëê®ËØ∏Â°ûÂ∑û", capital: "Boston", capitalCn: "Ê≥¢Â£´È°ø", population: 7029917, gdpPerCapita: 91130, fips: "25" },
  "MI": { name: "Michigan", cn: "ÂØÜÊ≠áÊ†πÂ∑û", capital: "Lansing", capitalCn: "ÂÖ∞Ëæõ", population: 10077331, gdpPerCapita: 52439, fips: "26" },
  "MN": { name: "Minnesota", cn: "ÊòéÂ∞ºËãèËææÂ∑û", capital: "Saint Paul", capitalCn: "Âú£‰øùÁΩó", population: 5706494, gdpPerCapita: 67456, fips: "27" },
  "MS": { name: "Mississippi", cn: "ÂØÜË•øË•øÊØîÂ∑û", capital: "Jackson", capitalCn: "Êù∞ÂÖãÈÄä", population: 2961279, gdpPerCapita: 38320, fips: "28" },
  "MO": { name: "Missouri", cn: "ÂØÜËãèÈáåÂ∑û", capital: "Jefferson City", capitalCn: "Êù∞ÊñêÈÄäÂüé", population: 6154913, gdpPerCapita: 51547, fips: "29" },
  "MT": { name: "Montana", cn: "ËíôÂ§ßÊãøÂ∑û", capital: "Helena", capitalCn: "Êµ∑‰º¶Â®ú", population: 1084225, gdpPerCapita: 49936, fips: "30" },
  "NE": { name: "Nebraska", cn: "ÂÜÖÂ∏ÉÊãâÊñØÂä†Â∑û", capital: "Lincoln", capitalCn: "ÊûóËÇØ", population: 1961504, gdpPerCapita: 64296, fips: "31" },
  "NV": { name: "Nevada", cn: "ÂÜÖÂçéËææÂ∑û", capital: "Carson City", capitalCn: "Âç°Ê£ÆÂüé", population: 3104614, gdpPerCapita: 55548, fips: "32" },
  "NH": { name: "New Hampshire", cn: "Êñ∞ÁΩïÂ∏É‰ªÄÂ∞îÂ∑û", capital: "Concord", capitalCn: "Â∫∑ÁßëÂæ∑", population: 1377529, gdpPerCapita: 65024, fips: "33" },
  "NJ": { name: "New Jersey", cn: "Êñ∞Ê≥ΩË•øÂ∑û", capital: "Trenton", capitalCn: "Áâπ‰º¶È°ø", population: 9288994, gdpPerCapita: 70800, fips: "34" },
  "NM": { name: "New Mexico", cn: "Êñ∞Â¢®Ë•øÂì•Â∑û", capital: "Santa Fe", capitalCn: "Âú£Ëè≤", population: 2117522, gdpPerCapita: 46718, fips: "35" },
  "NY": { name: "New York", cn: "Á∫ΩÁ∫¶Â∑û", capital: "Albany", capitalCn: "Â••Â∞îÂ∑¥Â∞º", population: 20201249, gdpPerCapita: 90043, fips: "36" },
  "NC": { name: "North Carolina", cn: "ÂåóÂç°ÁΩóÊù•Á∫≥Â∑û", capital: "Raleigh", capitalCn: "ÁΩóÂà©", population: 10439388, gdpPerCapita: 55452, fips: "37" },
  "ND": { name: "North Dakota", cn: "ÂåóËææÁßë‰ªñÂ∑û", capital: "Bismarck", capitalCn: "‰øæÊñØÈ∫¶", population: 779094, gdpPerCapita: 67649, fips: "38" },
  "OH": { name: "Ohio", cn: "‰øÑ‰∫•‰øÑÂ∑û", capital: "Columbus", capitalCn: "Âì•‰º¶Â∏É", population: 11799448, gdpPerCapita: 54768, fips: "39" },
  "OK": { name: "Oklahoma", cn: "‰øÑÂÖãÊãâËç∑È©¨Â∑û", capital: "Oklahoma City", capitalCn: "‰øÑÂÖãÊãâËç∑È©¨Âüé", population: 3959353, gdpPerCapita: 49889, fips: "40" },
  "OR": { name: "Oregon", cn: "‰øÑÂãíÂÜàÂ∑û", capital: "Salem", capitalCn: "Â°ûÂãíÂßÜ", population: 4237256, gdpPerCapita: 58057, fips: "41" },
  "PA": { name: "Pennsylvania", cn: "ÂÆæÂ§ïÊ≥ïÂ∞º‰∫öÂ∑û", capital: "Harrisburg", capitalCn: "ÂìàÈáåÊñØÂ†°", population: 13002700, gdpPerCapita: 61872, fips: "42" },
  "RI": { name: "Rhode Island", cn: "ÁΩóÂæ∑Â≤õÂ∑û", capital: "Providence", capitalCn: "ÊôÆÁΩóÁª¥ÁôªÊñØ", population: 1097379, gdpPerCapita: 58003, fips: "44" },
  "SC": { name: "South Carolina", cn: "ÂçóÂç°ÁΩóÊù•Á∫≥Â∑û", capital: "Columbia", capitalCn: "Âì•‰º¶ÊØî‰∫ö", population: 5118425, gdpPerCapita: 46539, fips: "45" },
  "SD": { name: "South Dakota", cn: "ÂçóËææÁßë‰ªñÂ∑û", capital: "Pierre", capitalCn: "ÁöÆÂ∞î", population: 886667, gdpPerCapita: 60297, fips: "46" },
  "TN": { name: "Tennessee", cn: "Áî∞Á∫≥Ë•øÂ∑û", capital: "Nashville", capitalCn: "Á∫≥‰ªÄÁª¥Â∞î", population: 6910840, gdpPerCapita: 55502, fips: "47" },
  "TX": { name: "Texas", cn: "ÂæóÂÖãËê®ÊñØÂ∑û", capital: "Austin", capitalCn: "Â••ÊñØÊ±Ä", population: 29145505, gdpPerCapita: 63588, fips: "48" },
  "UT": { name: "Utah", cn: "Áäπ‰ªñÂ∑û", capital: "Salt Lake City", capitalCn: "ÁõêÊπñÂüé", population: 3271616, gdpPerCapita: 60365, fips: "49" },
  "VT": { name: "Vermont", cn: "‰ΩõËíôÁâπÂ∑û", capital: "Montpelier", capitalCn: "ËíôÂΩºÂà©ÂüÉ", population: 643077, gdpPerCapita: 51831, fips: "50" },
  "VA": { name: "Virginia", cn: "ÂºóÂêâÂ∞º‰∫öÂ∑û", capital: "Richmond", capitalCn: "ÈáåÂ£´Êª°", population: 8631393, gdpPerCapita: 63652, fips: "51" },
  "WA": { name: "Washington", cn: "ÂçéÁõõÈ°øÂ∑û", capital: "Olympia", capitalCn: "Â••ÊûóÂåπ‰∫ö", population: 7614893, gdpPerCapita: 79506, fips: "53" },
  "WV": { name: "West Virginia", cn: "Ë•øÂºóÂêâÂ∞º‰∫öÂ∑û", capital: "Charleston", capitalCn: "Êü•Â∞îÊñØÈ°ø", population: 1793716, gdpPerCapita: 42019, fips: "54" },
  "WI": { name: "Wisconsin", cn: "Â®ÅÊñØÂ∫∑ÊòüÂ∑û", capital: "Madison", capitalCn: "È∫¶Ëø™ÈÄä", population: 5893718, gdpPerCapita: 57617, fips: "55" },
  "WY": { name: "Wyoming", cn: "ÊÄÄ‰øÑÊòéÂ∑û", capital: "Cheyenne", capitalCn: "Â§èÂª∂", population: 576851, gdpPerCapita: 68002, fips: "56" },
  "DC": { name: "District of Columbia", cn: "Âì•‰º¶ÊØî‰∫öÁâπÂå∫", capital: "Washington D.C.", capitalCn: "ÂçéÁõõÈ°øÁâπÂå∫", population: 689545, gdpPerCapita: 213034, fips: "11" }
};

// FIPS to abbreviation
const fipsToAbbr = {};
for (const [abbr, data] of Object.entries(stateData)) {
  fipsToAbbr[data.fips] = abbr;
}

// Color palette for states
const stateColors = [
  "#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6",
  "#ec4899", "#06b6d4", "#f97316", "#84cc16", "#6366f1",
  "#14b8a6", "#e11d48", "#0ea5e9", "#d946ef", "#22c55e",
  "#eab308", "#a855f7", "#f43f5e", "#2dd4bf", "#fb923c",
  "#4ade80", "#818cf8", "#fb7185", "#34d399", "#fbbf24",
  "#a78bfa", "#38bdf8", "#c084fc", "#4f46e5", "#059669",
  "#dc2626", "#7c3aed", "#0284c7", "#65a30d", "#db2777",
  "#0891b2", "#c026d3", "#ea580c", "#16a34a", "#9333ea",
  "#e879f9", "#2563eb", "#d97706", "#15803d", "#be123c",
  "#7e22ce", "#0369a1", "#b91c1c", "#047857", "#9f1239",
  "#6d28d9"
];

function getStateColor(abbr) {
  const keys = Object.keys(stateData);
  const idx = keys.indexOf(abbr);
  return stateColors[idx % stateColors.length];
}

// ========== MAP RENDERING ==========
const width = 960;
const height = 600;

const svg = d3.select("#map-svg")
  .attr("viewBox", `0 0 ${width} ${height}`)
  .attr("preserveAspectRatio", "xMidYMid meet");

const projection = d3.geoAlbersUsa()
  .scale(1200)
  .translate([width / 2, height / 2]);

const path = d3.geoPath().projection(projection);

// Load US topology data
const topoUrl = "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json";

d3.json(topoUrl).then(us => {
  const states = topojson.feature(us, us.objects.states).features;

  // Draw states
  const stateGroup = svg.append("g");

  stateGroup.selectAll("path")
    .data(states)
    .enter()
    .append("path")
    .attr("class", "state-path")
    .attr("d", path)
    .attr("fill", d => {
      const fipsId = String(d.id).padStart(2, '0');
      const abbr = fipsToAbbr[fipsId];
      return abbr ? getStateColor(abbr) : "#334155";
    })
    .attr("data-fips", d => String(d.id).padStart(2, '0'))
    .on("click", function(event, d) {
      const fipsId = String(d.id).padStart(2, '0');
      const abbr = fipsToAbbr[fipsId];
      if (abbr) showStateDetail(abbr, d);
    });

  // Add state labels
  const labelGroup = svg.append("g");

  states.forEach(d => {
    const fipsId = String(d.id).padStart(2, '0');
    const abbr = fipsToAbbr[fipsId];
    if (!abbr) return;

    const centroid = path.centroid(d);
    if (!centroid || isNaN(centroid[0])) return;

    // Adjust label positions for small/oddly shaped states
    const labelOffsets = {
      "FL": [14, 10], "LA": [0, 4], "MI": [14, 10],
      "CA": [-8, 0], "ID": [0, -4], "VA": [8, -2],
      "MD": [12, -6], "NJ": [8, 2], "DE": [10, 4],
      "CT": [12, 2], "RI": [14, 0], "MA": [16, -4],
      "NH": [10, -4], "VT": [0, -2], "HI": [0, 0],
      "DC": [14, 8]
    };

    const offset = labelOffsets[abbr] || [0, 0];
    const smallStates = ["CT", "RI", "DE", "DC", "NH", "VT", "MA", "NJ", "MD"];
    const isSmall = smallStates.includes(abbr);

    labelGroup.append("text")
      .attr("class", `state-label ${isSmall ? 'state-label-small' : ''}`)
      .attr("x", centroid[0] + offset[0])
      .attr("y", centroid[1] + offset[1])
      .text(abbr);
  });

  // Store features for later use
  window._stateFeatures = {};
  states.forEach(d => {
    const fipsId = String(d.id).padStart(2, '0');
    const abbr = fipsToAbbr[fipsId];
    if (abbr) window._stateFeatures[abbr] = d;
  });
});

// ========== MODAL FUNCTIONS ==========
function showStateDetail(abbr, feature) {
  const data = stateData[abbr];
  if (!data) return;

  document.getElementById("modal-state-name").textContent = data.name;
  document.getElementById("modal-state-name-cn").textContent = data.cn;
  document.getElementById("info-capital").textContent = data.capital;
  document.getElementById("info-capital-cn").textContent = data.capitalCn;
  document.getElementById("info-population").textContent = data.population.toLocaleString();
  document.getElementById("info-gdp").textContent = `$${data.gdpPerCapita.toLocaleString()}`;
  document.getElementById("info-abbrev").textContent = abbr;

  // Draw zoomed state shape
  drawStateShape(feature || window._stateFeatures[abbr], abbr);

  document.getElementById("modal-overlay").classList.add("active");
}

function drawStateShape(feature, abbr) {
  const shapeSvg = d3.select("#state-shape-svg");
  shapeSvg.selectAll("*").remove();

  if (!feature) return;

  const shapeProjection = d3.geoMercator();
  const shapePath = d3.geoPath().projection(shapeProjection);

  // Fit the state to the SVG viewport
  shapeProjection.fitSize([180, 160], feature);

  shapeSvg.append("path")
    .attr("d", shapePath(feature))
    .attr("fill", getStateColor(abbr))
    .attr("stroke", "#fff")
    .attr("stroke-width", 1.5)
    .attr("class", "zoomed-state")
    .attr("transform", "translate(10, 10)");
}

function closeModal() {
  document.getElementById("modal-overlay").classList.remove("active");
}

// ========== EVENT LISTENERS ==========
document.getElementById("modal-close").addEventListener("click", closeModal);
document.getElementById("modal-overlay").addEventListener("click", function(e) {
  if (e.target === this) closeModal();
});

document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") closeModal();
});

// ========== TEXT TO SPEECH ==========
document.getElementById("speak-btn").addEventListener("click", function() {
  const stateName = document.getElementById("modal-state-name").textContent;
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(stateName);
    utterance.lang = 'en-US';
    utterance.rate = 0.85;
    utterance.pitch = 1;

    // Try to use a good English voice
    const voices = window.speechSynthesis.getVoices();
    const englishVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Samantha')) ||
                         voices.find(v => v.lang === 'en-US') ||
                         voices.find(v => v.lang.startsWith('en'));
    if (englishVoice) utterance.voice = englishVoice;

    window.speechSynthesis.speak(utterance);

    // Visual feedback
    this.textContent = 'üîä Speaking...';
    utterance.onend = () => { this.textContent = 'üîä Hear Pronunciation'; };
  }
});

// Preload voices
if ('speechSynthesis' in window) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}
</script>
</body>
</html>
